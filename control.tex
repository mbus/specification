\svnInfo $Id$

\section{Control and Configuration Messages}
\label{sec:control}

\bus reserves three addresses: a {\em broadcast} address, the {\em control}
address, and an {\em extension} address. A single physical chip acting as
control node will have (at least) two addresses. The control chip should
respond to messages addressed to the bus controller at the control address and
messages addressed to the chip itself at the chip's unique address. This
separation permits a standard set of commands for \bus control nodes without
imposing limits on the messages sent to the chip that happens to house the
\bus controller.

\subsection{Broadcast (Address \texttt{0x0X}, \texttt{0xf000000X})}
\label{sec:control-broadcast}
\bus defines prefix 0 as the \textit{broadcast prefix}. Broadcast messages
are permitted to be of arbitrary length. Messages longer than 32~bits may be
silently dropped by nodes with small buffers. A node \textbf{must not}
interrupt a broadcast message to indicate buffer overflow. Other interrupts
are permitted for broadcast messages greater than 4~bytes in length.

As broadcast messages by definition target all endpoints, assigning functional
unit ID targets does not make sense. Instead, the functional unit ID field is
used to define broadcast {\em channels}. Broadcast channel selection is used
to differentiate between the different types of broadcast messages. \bus
reserves half of these channels and leaves the rest as implementation defined.
%
The MSB of the broadcast channel identifier (address bit~3) shall identify
\bus broadcast operations. If the MSB is {\tt 0} it indicates an official \bus
broadcast message as specified in this document and subsequent revisions.
Broadcast messages with a channel MSB of {\tt 1} are implementation defined.
It is recommended that nodes leveraging implementation-defined broadcast
channels provide a mechanism to dynamically select broadcast channel to help
mitigate conflicts.

A broadcast message that is not understood \textbf{must} be completely
ignored. During acknowledgement, an ignorant node shall forward.

\hl{TODO: Semantics of broadcast messages in the face of power-gated nodes.}

\subsubsection{Broadcast Messages and Power-Gating}
As power-gating of nodes is a \bus design consideration, \bus also defines the
responsibilities of power-gated nodes for broadcast messages. The {\tt
Bus~Controller} {\bf must} wake for every message. Wakeup shall occur during
the arbitration phase of a message. For non-broadcast messages, the {\tt
Bus~Controller} decides whether it will wake the node once it has received the
entire address. To simplify {\tt Bus~Controller} design, the same constraint
is imposed on broadcast messages: the {\tt Bus~Controller} should be able to
decide whether it will wake the node after receiving the complete address.
The implication is that the rules for waking nodes in response to broadcast
messages are grouped by broadcast channel. This requirement {\bf must} hold
true for all \bus broadcast channels and should hold true for any
implementation-defined channels.

Some messages (e.g. \nameref{cmd:query-devices}) require a response, but may
not require waking the node. The message semantics take priority over the
channel power rules. That is, if a message must be responded to and the {\tt
Bus~Controller} logic is too simple to respond, the {\tt Bus~Controller} {\bf
must} wake the node to respond.

\medskip\noindent
The \bus broadcast channel power rules are summarized here:
\begin{itemize}
  \item \nameref{sec:channel-0}
  \begin{itemize}
    \item Nodes responsible for performing enumeration {\bf must} be woken.
    \item All other nodes may be woken.
  \end{itemize}
  \item \nameref{sec:channel-1}
  \begin{itemize}
    \item Nodes {\bf must} obey the indicated power request.
    \item Nodes interested in snooping not affected by the request may be woken.
  \end{itemize}
  \item \nameref{sec:channel-2-6}
  \begin{itemize}
    \item Nodes capable of receiving arbitrary messages (e.g. CPU) may be
             woken.
    \item Fixed-function nodes (no software) {\bf must not} be woken.
  \end{itemize}
  \item \nameref{sec:channel-7}
  \begin{itemize}
    \item Nodes that ignore the Data channel {\bf must not} be woken.
    \item All other nodes may be woken.
  \end{itemize}
\end{itemize}
%
In all cases where a node may wake up, nodes shall be assumed to not wake up
unless explicitly stated otherwise.

\subsubsection{Broadcast Channels and Messages}
This section breaks down all of the defined \bus broadcast channels and messages.
All undefined channels are reserved and shall not be used. A node receiving a
broadcast message for a reserved channel shall ignore the message. It {\bf
must not} acknowledge a message on a reserved channel and {\bf must} forward
during the acknowledgement cycle.

All \bus broadcast messages, except those sent on \nameref{sec:channel-7},
follow a common template. The messages are 32~bits long. The four most
significant bits identify the message~type/command. Some messages do not
require all 32~bits. The unused bits are named {\em insignificant bits}.
Messages may be truncated, omitting the insignificant bits on the
wire\footnote{
  With the caveat that all \bus messages must be byte-aligned. Some
insignificant bits may still be sent on the wire as a consequence.}.

All examples are shown with short addresses for space. There is no distinction
between the use of the short or full broadcast address.
Bitfields are presented \textbf{\color{blue} Address}~+~\textbf{\color{OliveGreen} Data}.
Addresses are broken down into the \hlc[lightblue]{Broadcast Prefix} and the
\hlc[lightcyan]{Broadcast Channel}. Data is broken down into a
\hlc[lightgreen]{Message Type Specifier} and the message itself.
%
In the bitfields,
{\tt 0} and {\tt 1} indicate bits that must be set to that value, {\tt X}
indicates bits that depend on the current message, and {\tt Z} indicates bits
that should be {\em ignored}---accept any value, send as {\tt 0}.
\hlc[lightgray]{Insignificant Bits} are also indicated as {\tt Z}.

\paragraph{Broadcast Channel 0: Node Discovery and Enumeration}
\label{sec:channel-0}

Channel~0 is used for messages related to node discovery and enumeration.
Channel~0 messages either require a response or are a response. Channel~0
response messages should not be sent unless solicited. Nodes that are capable
of performing enumeration {\bf must} snoop all enumeration related messages
(\nameref{cmd:enumerate-node}, \nameref{cmd:query-response}). If a node's
enumeration controller is power-gated, it must be woken for these messages.

\subparagraph{Query Devices}
\label{cmd:query-devices}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0000}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0000}
      \bitbox{4}{ZZZZ}
      \colorbitbox{lightgray}{24}{ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

The query devices command is a request for all devices to broadcast their
static full prefix and currently assigned short prefix on the bus. Every \bus
node must prepare a \nameref{cmd:query-response} when this message is
received.

\medskip
\noindent
\textit{All nodes are required to support this message and respond.}

\subparagraph{Query/Enumerate Response}
\label{cmd:query-response}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0000}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0001}
      \bitbox{4}{ZZZZ}
      \bitbox{20}{Full Prefix}
      \bitbox{4}{Short Prefix}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message is sent in response to a \nameref{cmd:query-devices} or
\nameref{cmd:invalidate-prefix} request. When responding to
\nameref{cmd:query-devices}, every node will be transmitting their address,
and nodes should anticipate losing arbitration several times before they are
able to send their response.

The top four bits of the data field identify the message as a Query~Response.
The next four bits are ignored. The following 20~bits contain the full prefix
of the node. The final 4~bits are the currently assigned short prefix. Nodes
that have not been enumerated should report a short prefix of {\tt 0b1111}.

This message must be sent in response to \nameref{cmd:query-devices} or
\nameref{cmd:enumerate-node}. When responding to \nameref{cmd:query-devices},
nodes {\bf must} retry until the message is sent. When responding to
\nameref{cmd:enumerate-node}, nodes {\bf must not} retry sending if
arbitration is lost and {\bf must} retry sending if interrupted\footnote{
  An iterrupt should not occur during this message. Such an interrupt would be
  an error.
  }.

\medskip
\noindent
\textit{All nodes are required to support this message.}

\subparagraph{Enumerate Node}
\label{cmd:enumerate-node}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0000}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0010}
      \bitbox{4}{Short Prefix}
      \colorbitbox{lightgray}{24}{ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message assigns a short prefix to a device. All nodes that receive this
message and do not have an assigned short prefix {\bf must} attempt to reply
with a \nameref{cmd:query-response}. Nodes shall perform exactly one attempt
to reply to this message. The node that wins arbitration shall be assigned the
short prefix from this message. Nodes that lose arbitration shall remain
unchanged.

Nodes that have an assigned short prefix shall ignore this message.

\medskip
\noindent
\textit{All nodes are required to support this message and respond if
appropriate.}

\subparagraph{Invalidate Prefix}
\label{cmd:invalidate-prefix}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0000}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0011}
      \bitbox{4}{Short Prefix}
      \colorbitbox{lightgray}{24}{ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message clears the assignment of a short prefix. The bottom 4~bits
specifiy the node whose prefix shall be reset. A node shall reset its prefix
to \nameref{sec:spec-unassigned-short-prefix}. If the prefix to clear is set
to \nameref{sec:spec-unassigned-short-prefix}, then all nodes shall reset
their prefixes.

\paragraph{Broadcast Channel 1: Power}
\label{sec:channel-1}

Channel~1 is used to query and command the power state of \bus nodes.
Power-oblivious nodes may ignore channel~1. Power-aware nodes whose power
model does not align well with these commands may ignore channel~1 messages
{\em except} \nameref{cmd:all-sleep}. All nodes capable of entering a
low-power state {\bf must} enter its lowest power state in response to an
\nameref{cmd:all-sleep} message.

Nodes are implicitly waked when a message is addressed to them, explicitly
waking a node is unnecessary to communicate with it.
The definition of ``wake'' and ``sleep'' are implementation-defined.
Nodes interested in snooping power status may be woken for channel~1 messages,
but care should be taken to ensure that a node does not wake itself up to
snoop in the process of instructing itself to sleep.

\subparagraph{All Sleep}
\label{cmd:all-sleep}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0000}
      \bitbox{4}{ZZZZ}
      \colorbitbox{lightgray}{24}{ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

All nodes receiving this message {\bf must} immediately enter their lowest
possible power state. The bottom~28 bits of this message are reserved and
should be {\em ignored}.

\medskip
\noindent
\textit{All power-aware nodes are required to support this message.}

\subparagraph{All Wake}
\label{cmd:all-wake}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0001}
      \bitbox{4}{ZZZZ}
      \colorbitbox{lightgray}{24}{ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

All nodes receiving this message {\bf must} immediately wake up. The bottom
28~bits of this message are reserved and should be {\em ignored}.

\subparagraph{Selective Sleep By Short Prefix}
\label{cmd:selective-sleep-short}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0010}
      \bitbox{1}{Z}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{Z}
      \bitbox{4}{ZZZZ}
      \colorbitbox{lightgray}{8}{ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message instructs selected nodes to sleep. The 16~bits of data are
treated as a bit vector, mapping short prefixes to bit indicies. That is, the
node with short prefix {\tt 0b1101} is controlled by the second bit received
(bit~18 in the bit vector above). If a bit is set to
{\tt 1}, the selected node {\bf must} enter sleep mode. If a bit is set to
{\tt 0}, the selected node should not change power state. The bits for
prefixes {\tt 0b1111} and {\tt 0b0000} are ignored.

\subparagraph{Selective Wake By Short Prefix}
\label{cmd:selective-wake}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0011}
      \bitbox{1}{Z}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X} \bitbox{1}{X}
      \bitbox{1}{Z}
      \bitbox{4}{ZZZZ}
      \colorbitbox{lightgray}{8}{ZZZZ ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message instructs selected nodes to wake. The 16~bits of data are
treated as a bit vector, mapping short prefixes to bit indicies. That is, the
node with short prefix {\tt 0b1101} is controlled by the second bit received
(bit~18 in the bit vector above). If a bit is set to
{\tt 1}, the selected node {\bf must} wake up. If a bit is set to
{\tt 0}, the selected node should not change power state. The bits for
prefixes {\tt 0b1111} and {\tt 0b0000} are ignored.

\subparagraph{Selective Sleep By Full Prefix}
\label{cmd:selective-sleep-full}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0100}
      \bitbox{4}{ZZZZ}
      \bitbox{20}{Full Prefix}
      \bitbox{4}{ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message instructs selected nodes to sleep. Any node whose full prefix
matches {\bf must} enter sleep.

\subparagraph{Selective Wake By Full Prefix}
\label{cmd:selective-wake-full}
~

~

\begin{minipage}{\linewidth}
  \begin{varwidth}{.2\linewidth}
    \centering
    \begin{bytefield}{8}
      \bitheader{0-7} \\
      \colorbitbox{lightblue}{4}{0000}
      \colorbitbox{lightcyan}{4}{0001}
    \end{bytefield}
  \end{varwidth}
+
  \begin{varwidth}{.8\linewidth}
    \centering
    \begin{bytefield}[bitwidth=1.25em]{32}
      \bitheader{0-31} \\
      \colorbitbox{lightgreen}{4}{0100}
      \bitbox{4}{ZZZZ}
      \bitbox{20}{Full Prefix}
      \bitbox{4}{ZZZZ}
    \end{bytefield}
  \end{varwidth}
\end{minipage}

~

This message instructs selected nodes to wake. Any node whose full prefix
matches {\bf must} wake up.

\paragraph{Broadcast Channels 2-6: Reserved}
\label{sec:channel-2-6}

\paragraph{Broadcast Channel 7: Data}
\label{sec:channel-7}
~

\textbf{\hl{Not implementated in generation 1.}}

\subsection{Control (Address \texttt{0x01}, \texttt{0xf0000001})}
\label{sec:control-control}
\bus defines a set of common command messages to configure the bus. The chip
acting as the control node listens on the address {\tt 0x01} for \bus control
messages.

Control messages that seem like good ideas (get? set?):
\begin{itemize}
  \item Maximum message length
  \item Clock speed
  \item $t_{long}$ value?
  \item \ldots?
\end{itemize}

\subsection{Extension (Address \texttt{0xffffffff})}
This address is reserved for future extensions to \bus.

